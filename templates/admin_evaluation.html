<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Desk AI - Evaluation</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
            --accent-color: #0284c7;
            --success-color: #22c55e;
            --warning-color: #eab308;
            --danger-color: #ef4444;
            --card-bg: #ffffff;
            --header-bg: #ffffff;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: var(--header-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .header-content h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0f172a;
            margin: 0 0 5px 0;
        }

        .header-content p {
            color: #64748b;
            margin: 0;
            font-size: 0.95rem;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .nav-link {
            text-decoration: none;
            color: #64748b;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            background-color: #f1f5f9;
            color: #0f172a;
        }

        .nav-link.active {
            background-color: #e0f2fe;
            color: var(--accent-color);
        }

        /* Actions */
        .actions-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #0369a1;
        }

        .btn-primary:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .metric-title {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #0f172a;
        }

        .metric-desc {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 5px;
        }

        /* Results Table */
        .results-card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0f172a;
            margin: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #f8fafc;
            font-weight: 600;
            font-size: 0.8rem;
            color: #64748b;
            text-transform: uppercase;
        }

        .score-good {
            color: var(--success-color);
            font-weight: 600;
        }

        .score-avg {
            color: var(--warning-color);
            font-weight: 600;
        }

        .score-bad {
            color: var(--danger-color);
            font-weight: 600;
        }

        /* Loading Overlay */
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>RAG Evaluation</h1>
                <p>Assess pipeline performance using RAGAS metrics.</p>
                <nav class="nav-links">
                    <a href="{{ url_for('admin.index') }}" class="nav-link">Chat Feedback</a>
                    <a href="{{ url_for('admin.app_feedback_view') }}" class="nav-link">App Feedback</a>
                    <a href="{{ url_for('admin.analytics_view') }}" class="nav-link">Analytics</a>
                    <a href="{{ url_for('admin.evaluation_view') }}" class="nav-link active">Evaluation</a>
                </nav>
            </div>
        </header>

        <div class="actions-bar">
            <button id="runEvalBtn" class="btn-primary" onclick="runEvaluation()">Run Evaluation</button>
        </div>

        <!-- Summary Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-title">Faithfulness</div>
                <div class="metric-value" id="score-faithfulness">-</div>
                <div class="metric-desc">Accuracy of answer to context</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Answer Relevancy</div>
                <div class="metric-value" id="score-relevancy">-</div>
                <div class="metric-desc">Relevance to the question</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Context Precision</div>
                <div class="metric-value" id="score-precision">-</div>
                <div class="metric-desc">Quality of retrieved chunks</div>
            </div>
        </div>

        <!-- Detailed Results -->
        <div class="results-card">
            <div class="table-header">
                <h3 class="table-title">Detailed Results</h3>
                <span id="record-count" style="color: #64748b; font-size: 0.9rem;">0 records</span>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width: 40%;">Question</th>
                        <th>Faithfulness</th>
                        <th>Relevancy</th>
                        <th>Precision</th>
                    </tr>
                </thead>
                <tbody id="results-body">
                    <tr>
                        <td colspan="4" style="text-align: center; color: #94a3b8;">Run evaluation to see results.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div style="font-weight: 500; color: #0f172a;">Running Evaluation...</div>
        <div style="font-size: 0.9rem; color: #64748b;">This may take a few minutes.</div>
    </div>

    <script>
        function runEvaluation() {
            const btn = document.getElementById('runEvalBtn');
            const overlay = document.getElementById('loadingOverlay');

            if (!confirm('This will run evaluation on 50 synthetic test cases. It may take some time. Continue?')) {
                return;
            }

            btn.disabled = true;
            overlay.style.display = 'flex';

            fetch('/admin/run_evaluation', {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateUI(data.results);
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Error running evaluation: ' + error);
                })
                .finally(() => {
                    btn.disabled = false;
                    overlay.style.display = 'none';
                });
        }

        function updateUI(results) {
            // Update Summary
            document.getElementById('score-faithfulness').textContent = (results.faithfulness * 100).toFixed(1) + '%';
            document.getElementById('score-relevancy').textContent = (results.answer_relevancy * 100).toFixed(1) + '%';
            document.getElementById('score-precision').textContent = (results.context_precision * 100).toFixed(1) + '%';

            document.getElementById('record-count').textContent = results.details.length + ' records';

            // Update Table
            const tbody = document.getElementById('results-body');
            tbody.innerHTML = '';

            results.details.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="query-text">${row.question}</td>
                    <td class="${getScoreClass(row.faithfulness)}">${(row.faithfulness * 100).toFixed(0)}%</td>
                    <td class="${getScoreClass(row.answer_relevancy)}">${(row.answer_relevancy * 100).toFixed(0)}%</td>
                    <td class="${getScoreClass(row.context_precision)}">${(row.context_precision * 100).toFixed(0)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function getScoreClass(score) {
            if (score >= 0.8) return 'score-good';
            if (score >= 0.5) return 'score-avg';
            return 'score-bad';
        }
    </script>
</body>

</html>